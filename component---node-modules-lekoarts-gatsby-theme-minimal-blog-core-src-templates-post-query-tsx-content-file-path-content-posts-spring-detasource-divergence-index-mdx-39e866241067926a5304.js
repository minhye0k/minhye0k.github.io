"use strict";(self.webpackChunkminimal_blog=self.webpackChunkminimal_blog||[]).push([[540],{4765:function(e,n,t){t.d(n,{F:function(){return p},Z:function(){return g}});var a=t(7294),r=t(8733),l=t(795),c=t(1521),i=t(6799),o=t(8871);var u=e=>{let{post:n}=e;return null};const m=["16px","8px","4px"].map((e=>"rgba(0, 0, 0, 0.1) 0px "+e+" "+e+" 0px"));var s=e=>{let{data:{post:n},children:t}=e;return(0,r.tZ)(c.Z,null,(0,r.tZ)(l.X6,{as:"h1",variant:"styles.h1"},n.title),(0,r.tZ)("p",{sx:{color:"secondary",mt:3,a:{color:"secondary"},fontSize:[1,1,2]}},(0,r.tZ)("time",null,n.date),n.tags&&(0,r.tZ)(a.Fragment,null," — ",(0,r.tZ)(i.Z,{tags:n.tags})),n.timeToRead&&" — ",n.timeToRead&&(0,r.tZ)("span",null,n.timeToRead," min read")),(0,r.tZ)("section",{sx:{my:5,".gatsby-resp-image-wrapper":{my:[4,4,5],borderRadius:"4px",boxShadow:m.join(", "),".gatsby-resp-image-image":{borderRadius:"4px"}},variant:"layout.content"}},t),(0,r.tZ)(u,{post:n}))};const p=e=>{var n,t,a;let{data:{post:l}}=e;return(0,r.tZ)(o.Z,{title:l.title,description:l.description?l.description:l.excerpt,image:l.banner?null===(n=l.banner)||void 0===n||null===(t=n.childImageSharp)||void 0===t||null===(a=t.resize)||void 0===a?void 0:a.src:void 0,pathname:l.slug,canonicalUrl:l.canonicalUrl})};function g(e){let{...n}=e;return a.createElement(s,n)}},6799:function(e,n,t){var a=t(8733),r=t(7294),l=t(1883),c=t(3494),i=t(9706);n.Z=e=>{let{tags:n}=e;const{tagsPath:t,basePath:o}=(0,c.Z)();return(0,a.tZ)(r.Fragment,null,n.map(((e,n)=>(0,a.tZ)(r.Fragment,{key:e.slug},!!n&&", ",(0,a.tZ)(l.Link,{sx:e=>{var n;return{...null===(n=e.styles)||void 0===n?void 0:n.a}},to:(0,i.Z)("/"+o+"/"+t+"/"+e.slug)},e.name)))))}},8871:function(e,n,t){var a=t(7294),r=t(1883),l=t(4232);n.Z=e=>{let{title:n="",description:t="",pathname:c="",image:i="",children:o=null,canonicalUrl:u=""}=e;const m=(0,l.Z)(),{siteTitle:s,siteTitleAlt:p,siteUrl:g,siteDescription:d,siteImage:E,author:y,siteLanguage:b}=m,h={title:n?n+" | "+s:p,description:t||d,url:""+g+(c||""),image:""+g+(i||E)};return a.createElement(a.Fragment,null,a.createElement("html",{lang:b}),a.createElement("title",null,h.title),a.createElement("meta",{name:"description",content:h.description}),a.createElement("meta",{name:"image",content:h.image}),a.createElement("meta",{property:"og:title",content:h.title}),a.createElement("meta",{property:"og:url",content:h.url}),a.createElement("meta",{property:"og:description",content:h.description}),a.createElement("meta",{property:"og:image",content:h.image}),a.createElement("meta",{property:"og:type",content:"website"}),a.createElement("meta",{property:"og:image:alt",content:h.description}),a.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),a.createElement("meta",{name:"twitter:title",content:h.title}),a.createElement("meta",{name:"twitter:url",content:h.url}),a.createElement("meta",{name:"twitter:description",content:h.description}),a.createElement("meta",{name:"twitter:image",content:h.image}),a.createElement("meta",{name:"twitter:image:alt",content:h.description}),a.createElement("meta",{name:"twitter:creator",content:y}),a.createElement("meta",{name:"gatsby-theme",content:"@lekoarts/gatsby-theme-minimal-blog"}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"32x32",href:(0,r.withPrefix)("/favicon-32x32.png")}),a.createElement("link",{rel:"icon",type:"image/png",sizes:"16x16",href:(0,r.withPrefix)("/favicon-16x16.png")}),a.createElement("link",{rel:"apple-touch-icon",sizes:"180x180",href:(0,r.withPrefix)("/apple-touch-icon.png")}),u?a.createElement("link",{rel:"canonical",href:u}):null,o)}},3347:function(e,n,t){t.r(n),t.d(n,{Head:function(){return i.F},default:function(){return o}});var a=t(7294),r=t(1151);function l(e){const n=Object.assign({h2:"h2",hr:"hr",h4:"h4",p:"p",a:"a",code:"code",ol:"ol",li:"li",ul:"ul",h3:"h3",em:"em",strong:"strong",pre:"pre",span:"span"},(0,r.ah)(),e.components);return a.createElement(a.Fragment,null,a.createElement(n.h2,null,"Spring Application 에서 DB Read/Write 요청을 분산하는 법"),"\n",a.createElement(n.hr),"\n",a.createElement(n.h4,null,"들어가기에 앞서"),"\n",a.createElement(n.p,null,"우선 Read/Write 요청을 분산하기 위해서는 Database 또한 분리되어 있어야 한다. 이는 즉 Database Replication 이 필요하다는 의미이다.\n이에 대해선 이전에 다룬적이 있는데 ",a.createElement(n.a,{href:"https://minhye0k.github.io/database-replication-%EC%9D%80-%EC%99%9C-%ED%95%98%EB%8A%94%EA%B1%B8%EA%B9%8C-with-maria-db"},"Database Replication 은 왜 하는걸까?")," 를 통해 확인할 수 있다.\n이렇게 분리된 Database 와 함께 Spring Application 에서 ",a.createElement(n.code,null,"@Transactional")," 의 ",a.createElement(n.code,null,"readOnly")," 힌트를 이용해 Read/Write 요청을 알맞게 분산시킬 수 있다."),"\n",a.createElement(n.p,null,"지금부터 어떻게 동작이 이루어지는지에 대해 알아보고 실제로 구현까지 진행해보자."),"\n",a.createElement(n.hr),"\n",a.createElement(n.h4,null,"Our Goals"),"\n",a.createElement(n.ol,null,"\n",a.createElement(n.li,null,"DataSource Routing 이 어떻게 이루어지는지 이해한다."),"\n",a.createElement(n.li,null,"Read/Write 요청을 분산시키기 위한 DataSource Routing 을 구현할 수 있다."),"\n"),"\n",a.createElement(n.hr),"\n",a.createElement(n.h2,null,"구현 과정"),"\n",a.createElement(n.hr),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"환경"),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,"Spring Boot 2.5.6"),"\n",a.createElement(n.li,null,"MariaDB 11.0.2"),"\n",a.createElement(n.li,null,"Spring Data JPA"),"\n"),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"Read/Write DataSource Bean 생성"),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,a.createElement(n.em,null,a.createElement(n.strong,null,"yml 에 Database 정보 입력")),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-yml"},"spring:\n    datasource:\n        hikari:\n            primary:\n                jdbc-url: jdbc:mariadb://localhost:3307/test\n                username: root\n                driver-class-name: org.mariadb.jdbc.Driver\n            secondary:\n                jdbc-url: jdbc:mariadb://localhost:3308/test\n                username: root\n                driver-class-name: org.mariadb.jdbc.Driver\n")),"\n","primary 와 secondary 를 연동하기 위해 각각의 ",a.createElement(n.code,null,"url"),", ",a.createElement(n.code,null,"username"),", ",a.createElement(n.code,null,"driver-class-name")," 를 입력해주자.\n만약 ",a.createElement(n.code,null,"password")," 가 설정되어 있다면 추가로 입력해주어야 한다."),"\n",a.createElement(n.li,null,a.createElement(n.em,null,a.createElement(n.strong,null,"DataSource Bean 설정")),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},'@Configuration\npublic class DataSourceConfig {\n    @ConfigurationProperties(prefix = "spring.datasource.hikari.primary")\n    @Bean\n    public DataSource primaryDataSource() {\n        return DataSourceBuilder.create().type(HikariDataSource.class).build();\n    }\n\n    @ConfigurationProperties(prefix = "spring.datasource.hikari.secondary")\n    @Bean\n    public DataSource secondaryDataSource() {\n        return DataSourceBuilder.create().type(HikariDataSource.class).build();\n    }\n\n    ...(생략)\n} \n\n')),"\n",a.createElement(n.code,null,"yml")," 에 설정해주었던 정보를 기반으로 Bean 을 등록해주자."),"\n"),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"AbstractRoutingDataSource 설정 및 적용"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},"public class DynamicRoutingDataSource extends AbstractRoutingDataSource {\n\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return isCurrentTransactionReadOnly() ? SECONDARY : PRIMARY;\n    }\n}\n")),"\n",a.createElement(n.p,null,a.createElement(n.code,null,"AbstractRoutingDataSource")," 을 상속받아 ",a.createElement(n.code,null,"determineCurrentLooupKey()")," 를 Overriding 하여 현재 Transaction 의 readOnly\n값에 따라 적절한 DataSource 를 찾아서 연결할 수 있도록 하였다."),"\n",a.createElement(n.p,null,"이렇게 만든 ",a.createElement(n.code,null,"DynamicRoutingDataSource")," 를 적용해 줄 차례이다."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},'@Configuration\npublic class DataSourceConfig {\n    ...(생략)\n    @DependsOn({"primaryDataSource", "secondaryDataSource"})\n    @Bean\n    public DataSource routingDataSource(\n            @Qualifier("primaryDataSource") DataSource primary,\n            @Qualifier("secondaryDataSource") DataSource secondary) {\n        DynamicRoutingDataSource routingDataSource = new DynamicRoutingDataSource();\n\n        Map<Object, Object> dataSourceMap = new HashMap<>();\n\n        dataSourceMap.put(PRIMARY, primary);\n        dataSourceMap.put(SECONDARY, secondary);\n\n        routingDataSource.setTargetDataSources(dataSourceMap);\n        routingDataSource.setDefaultTargetDataSource(primary);\n\n        return routingDataSource;\n    }\n\n    @DependsOn({"routingDataSource"})\n    @Primary\n    @Bean\n    public DataSource dataSource(DataSource routingDataSource) {\n        return new LazyConnectionDataSourceProxy(routingDataSource);\n    }\n\n    ...(생략)\n}\n')),"\n",a.createElement(n.p,null,"위의 코드와 같이 ",a.createElement(n.code,null,"RoutingDataSource")," Bean 을 위에서 만든 클래스를 적용하여 등록해주고 이렇게 등록된 것을 다시\n",a.createElement(n.code,null,"LazyConnectionDataSourceProxy")," 로 감싸서 ",a.createElement(n.code,null,"DataSource")," Bean 을 등록해주면 된다."),"\n",a.createElement(n.p,null,"여기서 주의할 점은 ",a.createElement(n.code,null,"dataSource")," 에 ",a.createElement(n.code,null,"@Primary")," 애너테이션을 달아주어 기본 ",a.createElement(n.code,null,"DataSource")," 로 Bean 이 등록되게 해주자.\n이렇게 해야 ",a.createElement(n.code,null,"DataSource")," 주입이 필요한 다른 Bean (ex. ",a.createElement(n.code,null,"EntityManagerFactory"),") 이 정상적으로 생성되어 작동 할 수 있다."),"\n",a.createElement(n.p,null,"근데 ",a.createElement(n.code,null,"LazyConnectionDataSourceProxy")," 는 무슨 역할을 하는걸까?"),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"LazyConnectionDataSourceProxy"),"\n",a.createElement(n.p,null,"Spring 에서는 Transaction 에 접근 하는 순간 DataSource 의 커넥션을 가져온다.\n이러면 우리가 원했던 DataSource 분기 처리가 이루어지지 않는다."),"\n",a.createElement(n.p,null,"이러한 이유로 Transaction 이 시작되고 나서 실제 Query 가 실행될 때 DataSource 를 결정하도록 해야 하는데\n이 역할을 하는것이 바로 ",a.createElement(n.code,null,"LazyConnectionDataSourceProxy")," 이다."),"\n",a.createElement(n.p,null,"자세한 내용은 참고에 남긴 글에서 확인하면 좋다."),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"TransactionManager 설정"),"\n",a.createElement(n.p,null,"본 글에서는 JPA 를 사용하기 때문에, ",a.createElement(n.code,null,"jpaTransactionManager")," 를 설정해주었다."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},"@Configuration\npublic class DataSourceConfig {\n    ...(생략)\n\n    @Bean\n    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory){\n        JpaTransactionManager jpaTransactionManager = new JpaTransactionManager();\n        jpaTransactionManager.setEntityManagerFactory(entityManagerFactory);\n        return jpaTransactionManager;\n    }\n}\n")),"\n"),"\n"),"\n",a.createElement("br"),"\n",a.createElement(n.h2,null,"결과 확인"),"\n",a.createElement(n.hr),"\n",a.createElement(n.p,null,"분기가 잘 이루어지는지 확인하기 위해 ",a.createElement(n.code,null,"DynamicRoutingDataSource")," 에 아래와 같이 로그를 찍어 확인하였다."),"\n",a.createElement(n.pre,null,a.createElement(n.code,null,'@Slf4j\npublic class DynamicRoutingDataSource extends AbstractRoutingDataSource {\n\n    @Override\n    protected Object determineCurrentLookupKey() {\n        String dataSourceName = isCurrentTransactionReadOnly() ? SECONDARY : PRIMARY;\n        log.info(">>>>>> current data source : {}", dataSourceName);  \n        return dataSourceName;\n    }\n}\n')),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"테스트 코드"),"\n",a.createElement(n.p,null,"간단한 테스트를 위해 readOnly 설정된 Transaction 과 설정되지 않은 Transaction 에 대한 메서드를 만들었다."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},'@Service\n@RequiredArgsConstructor\npublic class ReplTestService {\n    private final static String TEST = "TEST";\n    private final ReplTestRepository replTestRepository;\n\n    @Transactional\n    public void postReplTest(){\n        log.info(">>>>> i am post repl test method");\n        replTestRepository.save(ReplTest.of(TEST));\n    }\n\n    @Transactional(readOnly = true)\n    public void getReplTest(){\n        log.info(">>>>> i am get repl test method");\n        replTestRepository.findAll();\n    }\n        \n}\n')),"\n",a.createElement(n.p,null,"그 다음 결과를 확인하기 위해 위의 코드에 대한 테스트 코드를 작성하였다."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-java"},"@SpringBootTest\nclass ReplicationApplicationTests {\n    @Autowired\n    private ReplTestService replTestService;\n\n    @Test\n    void 쓰기_전용() {\n        replTestService.postReplTest();\n    }\n\n    @Test\n    void 읽기_전용() {\n        replTestService.getReplTest();\n    }\n}\n\n")),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"Primary (쓰기 전용) 연결"),"\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 5%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATklEQVR42h3LOxJAMBRAUcsypFCYfJ+EECGjsP9NXDOKU57O+ILEmxAvbDhZ1oaahH60LKkxm4yXi7Q9v728eKkMyqHtgZP6vxBvZp35AO/cJgzq9zKoAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="primary"\n        title=""\n        src="/static/9b6109d4e146a9f84b2db1607a768a4f/7d769/primary.png"\n        srcset="/static/9b6109d4e146a9f84b2db1607a768a4f/5243c/primary.png 240w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/ab158/primary.png 480w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/7d769/primary.png 960w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/cfb3a/primary.png 979w"\n        sizes="(max-width: 960px) 100vw, 960px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n"),"\n",a.createElement(n.li,null,"\n",a.createElement(n.h3,null,"Secondary (읽기 전용) 연결"),"\n",a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 5%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAATklEQVR42h3LOxJAMBRAUcsypFCYfJ+EECGjsP9NXDOKU57O+ILEmxAvbDhZ1oaahH60LKkxm4yXi7Q9v728eKkMyqHtgZP6vxBvZp35AO/cJgzq9zKoAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="secondary"\n        title=""\n        src="/static/9b6109d4e146a9f84b2db1607a768a4f/7d769/primary.png"\n        srcset="/static/9b6109d4e146a9f84b2db1607a768a4f/5243c/primary.png 240w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/ab158/primary.png 480w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/7d769/primary.png 960w,\n/static/9b6109d4e146a9f84b2db1607a768a4f/cfb3a/primary.png 979w"\n        sizes="(max-width: 960px) 100vw, 960px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}}),"\n"),"\n"),"\n",a.createElement("br"),"\n",a.createElement(n.h2,null,"마치며"),"\n",a.createElement(n.hr),"\n",a.createElement(n.p,null,"write/read Query 를 분산하기 위한 Spring 에서의 DataSource 분기에 대해 알아보았다."),"\n",a.createElement(n.p,null,"이외에도 데이터베이스 분산 환경에서 Multi DataSource 가 필요할때도 이러한 분기 처리를 적용할 수 있다."),"\n",a.createElement(n.p,null,"이 글의 전체 코드는 ",a.createElement(n.a,{href:"https://github.com/minhye0k/blog-code/tree/main/replication"},"여기")," 에서 확인할 수 있다."),"\n",a.createElement("br"),"\n",a.createElement(n.h2,null,"참고"),"\n",a.createElement(n.hr),"\n",a.createElement(n.ul,null,"\n",a.createElement(n.li,null,a.createElement(n.a,{href:"https://sup2is.github.io/2021/07/08/lazy-connection-datasource-proxy.html"},"LazyConnectionDataSourceProxy 알아보기")),"\n"))}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?a.createElement(n,e,a.createElement(l,e)):l(e)},i=t(4765);function o(e){return a.createElement(i.Z,e,a.createElement(c,e))}i.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-spring-detasource-divergence-index-mdx-39e866241067926a5304.js.map